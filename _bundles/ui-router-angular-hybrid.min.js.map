{"version":3,"file":"ui-router-angular-hybrid.min.js","sources":["../src/angular-hybrid.ts"],"sourcesContent":["import * as angular from 'angular';\r\n\r\nimport { Component, ElementRef, Inject, Injector, Input, NgModule, Provider } from '@angular/core';\r\nimport { downgradeComponent, UpgradeModule } from '@angular/upgrade/static';\r\nimport {} from '@angular/upgrade';\r\n\r\nimport {\r\n  StateObject, forEach, PathNode, Resolvable, StateRegistry, UIRouter, ViewConfig, ViewService\r\n} from '@uirouter/core';\r\n\r\nimport {\r\n  applyModuleConfig, NATIVE_INJECTOR_TOKEN, ng2LazyLoadBuilder, Ng2ViewConfig, UIView, _UIROUTER_SERVICE_PROVIDERS,\r\n  Ng2ViewDeclaration, ParentUIViewInject, StatesModule, UIROUTER_MODULE_TOKEN, UIROUTER_ROOT_MODULE, UIRouterModule,\r\n} from '@uirouter/angular';\r\n\r\nimport { $InjectorLike, Ng1ViewConfig, StateProvider } from '@uirouter/angularjs';\r\n\r\nimport { UIRouterRx } from '@uirouter/rx';\r\n\r\n/**\r\n * Create a ng1 module for the ng1 half of the hybrid application to depend on.\r\n *\r\n * Example:\r\n * const myApp = angular.module('myApp', ['ui.router.upgrade']);\r\n */\r\nexport const upgradeModule = angular.module('ui.router.upgrade', ['ui.router']);\r\n\r\n/**\r\n * UIViewNgUpgrade is a component bridge from ng1 ui-view to ng2 ui-view\r\n *\r\n * When a ui-router for ng1 is registering a state it checks if a view's\r\n * `component:` is an ng2 Component class. If so, it creates a special ng1 template\r\n * which references this component, i.e., <ui-view-ng-upgrade></ui-view-ng-upgrade>\r\n *\r\n * See that code by searching ng1-to-ng2 source for: \"$stateProvider.decorator\"\r\n *\r\n * ---\r\n *\r\n * ng1-to-ng2 component bridge process:\r\n *\r\n * 1)\r\n * When an ng1 template creates a ui-view which is targeted by a ng2 Component,\r\n *\r\n * ```\r\n * <a ui-sref=\"foo\">Go to foo</a>\r\n * <div ui-view> <!-- ui-view created in ng1 template -->\r\n * </div> <!-- targeted with { component: Ng2RoutedComponent } -->\r\n * ```\r\n *\r\n * the state decorator spits out a custom template.  That template loads this\r\n * ng2 Component adapter as a downgraded-to-ng1 directive.\r\n *\r\n * ```\r\n * <a ui-sref=\"foo\">Go to foo</a>\r\n * <div ui-view> <!-- decorated template references the downgraded component -->\r\n *   <ui-view-ng-upgrade> <!-- downgraded adapter component -->\r\n *   </ui-view-ng-upgrade>\r\n * </div>\r\n * ```\r\n *\r\n * This downgraded ng2 Component then creates a child UIView (ng2 component)\r\n *\r\n * ```\r\n * <a ui-sref=\"foo\">Go to foo</a>\r\n * <div ui-view> <!-- custom template references the downgraded component -->\r\n *   <ui-view-ng-upgrade> <!-- ng2 component adapter downgraded to ng1-->\r\n *     <ui-view> <!-- pure ng2 ui-view -->\r\n *      </ui-view>\r\n *   </ui-view-ng-upgrade>\r\n * </div>\r\n * ```\r\n *\r\n * which in turn is filled with the routed ng2 component.\r\n *\r\n * ```\r\n * <a ui-sref=\"foo\">Go to foo</a>\r\n * <div ui-view> <!-- ng1 ui-view -->\r\n *   <ui-view-ng-upgrade> <!-- ng2 component adapter (downgraded to ng1)-->\r\n *     <ui-view> <!-- pure ng2 ui-view -->\r\n *       <ng2-routed-component> <!-- ng2 component hosted in ng2 ui-view -->\r\n *         <h1>ng2 routed component contents</h1>\r\n *       </ng2-routed-component>\r\n *     </ui-view>\r\n *   </ui-view-ng-upgrade>\r\n * </div>\r\n * ```\r\n *\r\n * This adapter exposes exposes the parent view context (ParentUIViewInject)\r\n * as an ng2 DI Provider, which the nested ng2 UIView requires.\r\n *\r\n * It gets the ParentUIViewContext information (from the parent ng1 ui-view) by walking\r\n * up the DOM and grabbing the .data('$uiView') which the ng1 ui-view directive exposes.\r\n */\r\n@Component({\r\n  selector: 'ui-view-ng-upgrade',\r\n  template: `<ui-view [name]=\"name\"></ui-view>`,\r\n  // provide a blank object as PARENT_INJECT.\r\n  // The component will add property getters when it is constructed.\r\n  viewProviders: [ { provide: UIView.PARENT_INJECT, useValue: { } } ],\r\n})\r\nexport class UIViewNgUpgrade {\r\n  // The ui-view's name (or '$default')\r\n  @Input() name: string;\r\n\r\n  constructor(\r\n      ref: ElementRef,\r\n      @Inject(UIView.PARENT_INJECT) parent: ParentUIViewInject,\r\n      registry: StateRegistry // access the root state\r\n  ) {\r\n    // From the ui-view-ng-upgrade component's element ref, walk up the DOM two elements...\r\n    // There will first be an ng1 ui-view which hosts this element, and then that ui-view's parent element.\r\n    // That (parent) element has access to the proper \"parent viewcontext\"\r\n\r\n    // The ng2 ui-view component is inside this ui-view-ng-upgrade directive, which is inside the ng1 \"host\" ui-view.\r\n    // Both ui-views share the same \"view context\" information (the view's fqn and created-by-state context information)\r\n    const ng1elem = angular.element(ref.nativeElement).parent().parent();\r\n\r\n    // Expose getters on PARENT_INJECT for context (creation state) and fqn (view address)\r\n    // These will be used by further nested UIView\r\n    Object.defineProperty(parent, \"context\", {\r\n      get: function() {\r\n        const data = ng1elem['inheritedData']('$uiView');\r\n        return (data && data.$cfg) ? data.$cfg.viewDecl.$context : registry.root();\r\n      },\r\n      enumerable: true\r\n    });\r\n\r\n    Object.defineProperty(parent, \"fqn\", {\r\n      get: function() {\r\n        const data = ng1elem['inheritedData']('$uiView');\r\n        return (data && data.$uiView) ? data.$uiView.fqn : null;\r\n      },\r\n      enumerable: true\r\n    });\r\n  }\r\n}\r\n\r\n/**********************************\r\n * Ng2 @NgModule and bootstrap code\r\n **********************************/\r\n\r\n// Register the ng1 DI '$uiRouter' object as an ng2 Provider.\r\nexport function uiRouterUpgradeFactory(router: UIRouter, injector: Injector) {\r\n  const modules: StatesModule[] = injector.get(UIROUTER_MODULE_TOKEN, []);\r\n  modules.forEach(module => applyModuleConfig(router, injector, module));\r\n  return router;\r\n}\r\n\r\nexport function getUIRouter($injector: any) {\r\n  return $injector.get('$uiRouter');\r\n}\r\n\r\nexport function getParentUIViewInject(r: StateRegistry): ParentUIViewInject {\r\n  return { fqn: null, context: r.root() };\r\n}\r\n\r\n/**\r\n * This NgModule should be added to the root module of the hybrid app.\r\n */\r\n@NgModule({\r\n  imports: [UIRouterModule, UpgradeModule],\r\n  declarations: [UIViewNgUpgrade],\r\n  providers: [\r\n    // @uirouter/angular code will use the ng1 $uiRouter instance instead of creating its own.\r\n    { provide: '$uiRouter', useFactory: getUIRouter, deps: ['$injector']},\r\n\r\n    { provide: UIRouter, useFactory: uiRouterUpgradeFactory, deps: ['$uiRouter', Injector] },\r\n\r\n    { provide: UIROUTER_ROOT_MODULE, useValue: {}, multi: true },\r\n\r\n    { provide: UIView.PARENT_INJECT, useFactory: getParentUIViewInject, deps: [StateRegistry] },\r\n\r\n    ..._UIROUTER_SERVICE_PROVIDERS,\r\n  ],\r\n  entryComponents: [\r\n    UIViewNgUpgrade\r\n  ],\r\n  exports: [UIViewNgUpgrade, UIRouterModule]\r\n}) export class UIRouterUpgradeModule {}\r\n\r\n// Downgrade the UIViewNgUpgrade ng2 Component to an ng1 directive.\r\n// The directive is used in a (generated) view template by the (host) ng1 ui-router,\r\n// whenever it finds a view configured with a `component: <Ng2ComponentClass>`\r\nupgradeModule.directive(\"uiViewNgUpgrade\", <any> downgradeComponent({ \r\n  component: UIViewNgUpgrade,\r\n  inputs: ['name']\r\n}));\r\n\r\nupgradeModule.run(['$injector', (ng1Injector: $InjectorLike) => {\r\n  const $uiRouter: UIRouter = ng1Injector.get('$uiRouter');\r\n\r\n  /** Add support for observable state and param changes */\r\n  $uiRouter.plugin(UIRouterRx);\r\n\r\n  // Expose a merged ng1/ng2 injector as a Resolvable (on the root state).\r\n  // This mimics how ui-router-ng2 exposes the root ng2 Injector, but\r\n  // it retrieves from ng1 injector first, then ng2 injector if the token isn't found.\r\n  const mergedInjector = {\r\n    get: function(token: any, ng2NotFoundValue?: any) {\r\n      const ng2Injector = ng1Injector.get('$$angularInjector');\r\n      return (ng1Injector.has(token) && ng1Injector.get(token)) || ng2Injector.get(token, ng2NotFoundValue)\r\n    }\r\n  };\r\n\r\n  const ng2InjectorResolvable = Resolvable.fromData(NATIVE_INJECTOR_TOKEN, mergedInjector);\r\n  $uiRouter.stateRegistry.root().resolvables.push(ng2InjectorResolvable);\r\n}]);\r\n\r\n/** Adds support for `loadChildren`: Angular NgModule lazy loading via @gntools/webpack */\r\nupgradeModule.config(['$stateRegistryProvider', ($stateRegistry: StateRegistry) => {\r\n  $stateRegistry.decorator('lazyLoad', ng2LazyLoadBuilder);\r\n}]);\r\n\r\n/**\r\n * Define a stateProvider `views` builder decorator.\r\n * The decorator first applies the standard views builder function.\r\n * Then it finds any view components which are **actually** a Ng2 Component Class.\r\n * It overwrites that view's config with a ng1-to-ng2 hybrid config.\r\n *\r\n * In place of the template provider, it simply puts a <ui-view-ng-upgrade/> component\r\n * which that provides a ng1 -> ng2 boundary in the component tree.\r\n */\r\nupgradeModule.config(['$stateRegistryProvider', ($stateRegistry: StateRegistry) => {\r\n  $stateRegistry.decorator('views', function(state: StateObject, parentFn: Function) {\r\n    const views = parentFn(state);\r\n\r\n    forEach(views, (viewDecl: any, viewName: string) => {\r\n      if (viewDecl.$type === 'ng1-to-ng2' || typeof viewDecl.component === 'function') {\r\n        // Update the view config.\r\n        // Override default ng1 `component:` behavior (of defining a templateProvider)\r\n        // with a <ui-view-ng-upgrade> adapter directive template\r\n        viewDecl.$type = \"ng1-to-ng2\";\r\n        viewDecl.templateProvider = null;\r\n        viewDecl.template = `<ui-view-ng-upgrade name='${viewDecl.$uiViewName}'></ui-view-ng-upgrade>`;\r\n      }\r\n    });\r\n    return views;\r\n  });\r\n}]);\r\n\r\n// UI-Router ViewConfig factories take a view declaration object from a state.views: { foo: <ViewDeclaration> }\r\n// and return a runtime config object (a ViewConfig)\r\nupgradeModule.run(['$view', '$templateFactory', ($view: ViewService, $templateFactory: any) => {\r\n  // Register a ViewConfig factory for views of type `ng2`\r\n  $view._pluginapi._viewConfigFactory('ng2', (path: PathNode[], config: Ng2ViewDeclaration) => new Ng2ViewConfig(path, config));\r\n\r\n  // Register a ViewConfig factory for views of type `ng1-to-ng2`.\r\n  // Returns both an ng1 config and an ng2 config allowing either ng1 or ng2 ui-view components to be targeted.\r\n  $view._pluginapi._viewConfigFactory('ng1-to-ng2', (path: PathNode[], config: Ng2ViewDeclaration) => {\r\n    const ng1ViewConfig: ViewConfig = <any> new Ng1ViewConfig(<any> path, <any> Object.assign({}, config, { $type: 'ng1'}), $templateFactory);\r\n    const ng2ViewConfig: ViewConfig = <any> new Ng2ViewConfig(<any> path, <any> Object.assign({}, config, { $type: 'ng2'}));\r\n\r\n    return [ ng2ViewConfig, ng1ViewConfig ];\r\n  });\r\n}]);\r\n"],"names":["router","injector","get","UIROUTER_MODULE_TOKEN","forEach","module","applyModuleConfig","$injector","r","fqn","context","root","upgradeModule","angular.module","ref","parent","registry","ng1elem","angular.element","nativeElement","Object","defineProperty","data","$cfg","viewDecl","$context","enumerable","$uiView","type","Component","args","selector","template","viewProviders","provide","UIView","PARENT_INJECT","useValue","UIViewNgUpgrade","ElementRef","undefined","decorators","Inject","StateRegistry","name","Input","NgModule","imports","UIRouterModule","UpgradeModule","declarations","providers","useFactory","getUIRouter","deps","UIRouter","uiRouterUpgradeFactory","Injector","UIROUTER_ROOT_MODULE","multi","getParentUIViewInject","_UIROUTER_SERVICE_PROVIDERS","entryComponents","exports","UIRouterUpgradeModule","directive","downgradeComponent","component","inputs","run","ng1Injector","$uiRouter","plugin","UIRouterRx","mergedInjector","token","ng2NotFoundValue","ng2Injector","has","ng2InjectorResolvable","Resolvable","fromData","NATIVE_INJECTOR_TOKEN","stateRegistry","resolvables","push","config","$stateRegistry","decorator","ng2LazyLoadBuilder","state","parentFn","views","viewName","$type","templateProvider","$uiViewName","$view","$templateFactory","_pluginapi","_viewConfigFactory","path","Ng2ViewConfig","ng1ViewConfig","Ng1ViewConfig","assign"],"mappings":"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"}